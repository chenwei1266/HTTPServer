<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo — 简洁任务管理</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #f5f0e8;
      --surface:   #ede8dc;
      --border:    #cdc8bc;
      --ink:       #1a1814;
      --ink-muted: #6b6760;
      --accent:    #c0392b;
      --accent-lt: #e8d5d3;
      --done:      #3d8b5f;
    }

    body {
      background: var(--bg);
      color: var(--ink);
      font-family: 'DM Mono', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 24px 80px;
    }

    /* ── Header ── */
    header {
      width: 100%;
      max-width: 560px;
      margin-bottom: 48px;
    }

    .label {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: var(--ink-muted);
      margin-bottom: 6px;
    }

    h1 {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(2.4rem, 6vw, 3.6rem);
      font-weight: 400;
      line-height: 1;
      letter-spacing: -.02em;
    }

    h1 em { font-style: italic; color: var(--accent); }

    .subtitle {
      margin-top: 10px;
      font-size: 12px;
      color: var(--ink-muted);
    }

    /* ── Input area ── */
    .compose {
      width: 100%;
      max-width: 560px;
      display: flex;
      gap: 0;
      margin-bottom: 36px;
      border: 1.5px solid var(--border);
      background: #fff;
      transition: border-color .2s;
    }
    .compose:focus-within { border-color: var(--ink); }

    .compose input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      padding: 14px 16px;
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      color: var(--ink);
    }
    .compose input::placeholder { color: var(--border); }

    .compose button {
      border: none;
      border-left: 1.5px solid var(--border);
      background: var(--ink);
      color: var(--bg);
      padding: 14px 22px;
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      letter-spacing: .08em;
      cursor: pointer;
      transition: background .15s;
    }
    .compose button:hover { background: var(--accent); }

    /* ── Stats bar ── */
    .stats {
      width: 100%;
      max-width: 560px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }
    .stats-count { font-size: 11px; color: var(--ink-muted); }
    .clear-btn {
      background: none; border: none;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--ink-muted);
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .clear-btn:hover { color: var(--accent); }

    /* ── Todo list ── */
    #list {
      width: 100%;
      max-width: 560px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border: 1.5px solid var(--border);
      border-top: none;
      background: #fff;
      transition: background .15s;
      animation: slideIn .22s ease both;
    }
    .todo-item:first-child { border-top: 1.5px solid var(--border); }
    .todo-item:hover { background: var(--surface); }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: none; }
    }

    /* custom checkbox */
    .todo-item input[type="checkbox"] { display: none; }
    .check {
      width: 18px; height: 18px;
      border: 1.5px solid var(--border);
      flex-shrink: 0;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: border-color .15s, background .15s;
    }
    .check:hover { border-color: var(--done); }
    .check.checked {
      background: var(--done);
      border-color: var(--done);
    }
    .check.checked::after {
      content: '';
      width: 10px; height: 6px;
      border-left: 2px solid #fff;
      border-bottom: 2px solid #fff;
      transform: rotate(-45deg) translateY(-1px);
    }

    .todo-text {
      flex: 1;
      font-size: 13px;
      line-height: 1.5;
      transition: color .15s;
    }
    .todo-text.done {
      color: var(--ink-muted);
      text-decoration: line-through;
      text-decoration-color: var(--border);
    }

    .del-btn {
      background: none; border: none;
      color: var(--border);
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      padding: 0 2px;
      transition: color .15s;
    }
    .del-btn:hover { color: var(--accent); }

    /* ── Empty state ── */
    .empty {
      width: 100%;
      max-width: 560px;
      border: 1.5px dashed var(--border);
      padding: 40px;
      text-align: center;
      color: var(--ink-muted);
      font-size: 12px;
      line-height: 2;
    }
    .empty em {
      display: block;
      font-family: 'Instrument Serif', serif;
      font-style: italic;
      font-size: 1.5rem;
      color: var(--border);
      margin-bottom: 8px;
    }

    /* ── Toast ── */
    #toast {
      position: fixed;
      bottom: 32px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--ink);
      color: var(--bg);
      font-size: 12px;
      padding: 10px 20px;
      opacity: 0;
      transition: opacity .2s, transform .2s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<header>
  <p class="label">个人任务管理</p>
  <h1>My <em>Todo</em></h1>
  <p class="subtitle">— 基于 HttpServer 框架的 REST 示例 —</p>
</header>

<!-- 输入区 -->
<div class="compose">
  <input id="inp" type="text" placeholder="输入任务，按 Enter 或点击添加…" maxlength="120">
  <button onclick="addTodo()">ADD</button>
</div>

<!-- 统计栏 -->
<div class="stats">
  <span class="stats-count" id="stats">共 0 条</span>
  <button class="clear-btn" onclick="clearDone()">清除已完成</button>
</div>

<!-- 列表 -->
<div id="list"></div>

<div id="toast"></div>

<script>
// ─────────────────────────────────────────────
// 配置：后端 API 地址（与 HttpServer 监听端口一致）
// ─────────────────────────────────────────────
const API = ''; // 相对路径，和页面同域，无跨域问题

// 本地状态（done 状态存在前端，因为后端示例只存文字）
let todos = [];   // [{ id, text, done }]
let nextId = 1;

// ─────────────────────────────────────────────
// 初始化：从服务器拉取现有 todo
// ─────────────────────────────────────────────
// 从服务器拉取最新列表并渲染（init 和 addTodo 共用）
async function refreshTodos() {
  const res = await fetch(`${API}/todos`);
  const data = await res.json();   // 返回字符串数组
  // 保留已有条目的 done 状态，只更新文字列表
  const doneSet = new Set(todos.filter(t => t.done).map(t => t.text));
  todos = data.map(text => ({ id: nextId++, text, done: doneSet.has(text) }));
  render();
}

async function init() {
  try {
    await refreshTodos();
  } catch (e) {
    toast('⚠ 无法连接服务器，请确认后端已启动');
  }
}

// ─────────────────────────────────────────────
// 添加 todo（POST /todos）
// ─────────────────────────────────────────────
async function addTodo() {
  const inp = document.getElementById('inp');
  const text = inp.value.trim();
  if (!text) return;

  try {
    const res = await fetch(`${API}/todos`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    if (res.ok) {
      inp.value = '';
      // POST 成功后重新从服务器拉取完整列表，保证前后端数据一致
      await refreshTodos();
      toast('✓ 已添加');
    }
  } catch (e) {
    toast('⚠ 添加失败，服务器未响应');
  }
}

// ─────────────────────────────────────────────
// 删除（前端移除，无需额外后端接口）
// ─────────────────────────────────────────────
function deleteTodo(id) {
  todos = todos.filter(t => t.id !== id);
  render();
}

// 切换完成状态（纯前端）
function toggleDone(id) {
  const t = todos.find(t => t.id === id);
  if (t) { t.done = !t.done; render(); }
}

// 清除已完成
function clearDone() {
  todos = todos.filter(t => !t.done);
  render();
  toast('已清除完成项');
}

// ─────────────────────────────────────────────
// 渲染
// ─────────────────────────────────────────────
function render() {
  const list = document.getElementById('list');
  const stats = document.getElementById('stats');
  const done = todos.filter(t => t.done).length;
  stats.textContent = `共 ${todos.length} 条  ·  已完成 ${done} 条`;

  if (todos.length === 0) {
    list.innerHTML = `
      <div class="empty">
        <em>空空如也</em>
        在上方输入，开始记录今天的任务吧。
      </div>`;
    return;
  }

  list.innerHTML = todos.map(t => `
    <div class="todo-item" id="item-${t.id}">
      <div class="check ${t.done ? 'checked' : ''}" onclick="toggleDone(${t.id})"></div>
      <span class="todo-text ${t.done ? 'done' : ''}">${escHtml(t.text)}</span>
      <button class="del-btn" onclick="deleteTodo(${t.id})" title="删除">×</button>
    </div>
  `).join('');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ─────────────────────────────────────────────
// Toast 提示
// ─────────────────────────────────────────────
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2200);
}

// Enter 键提交
document.getElementById('inp').addEventListener('keydown', e => {
  if (e.key === 'Enter') addTodo();
});

init();
</script>
</body>
</html>