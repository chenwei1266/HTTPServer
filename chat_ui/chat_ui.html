<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 对话</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0e0e10;
    --surface:   #18181c;
    --surface2:  #222228;
    --border:    #2e2e38;
    --text:      #e8e8ed;
    --muted:     #8888a0;
    --accent:    #7b6ef6;
    --accent2:   #c4b5fd;
    --user-bg:   #1e1e2e;
    --ai-bg:     #18181c;
    --scrollbar: #2e2e38;
    --code-bg:   #13131a;
    --danger:    #f87171;
    --success:   #4ade80;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Serif SC', serif;
    font-size: 15px;
    line-height: 1.75;
    overflow: hidden;
  }

  /* ── Layout ── */
  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 100vh;
    height: 100vh;
  }

  /* ── Sidebar ── */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 20px 16px;
    gap: 12px;
    overflow: hidden;
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 8px 16px;
    border-bottom: 1px solid var(--border);
  }

  .logo-mark {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .logo-text {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
    letter-spacing: 0.02em;
  }

  .new-chat-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    text-align: left;
  }
  .new-chat-btn:hover {
    background: var(--surface2);
    color: var(--text);
    border-color: var(--accent);
  }
  .new-chat-btn svg { flex-shrink: 0; }

  .chat-history-label {
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 4px 8px;
    margin-top: 4px;
  }

  .chat-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .chat-item {
    padding: 8px 12px;
    border-radius: 7px;
    font-size: 13px;
    color: var(--muted);
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.15s;
    border: 1px solid transparent;
  }
  .chat-item:hover { background: var(--surface2); color: var(--text); }
  .chat-item.active {
    background: var(--surface2);
    color: var(--text);
    border-color: var(--border);
  }

  .sidebar-footer {
    border-top: 1px solid var(--border);
    padding-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .model-select {
    width: 100%;
    padding: 8px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    outline: none;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238888a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }
  .model-select:focus { border-color: var(--accent); }

  .status-dot {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--muted);
    padding: 4px 4px;
  }
  .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }
  .dot.connected { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .dot.error     { background: var(--danger); }

  /* ── Main Chat Area ── */
  .main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  /* Header */
  .chat-header {
    padding: 18px 28px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    background: var(--bg);
    backdrop-filter: blur(10px);
  }

  .chat-title {
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .icon-btn {
    width: 32px; height: 32px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.15s;
  }
  .icon-btn:hover { background: var(--surface2); color: var(--text); }

  /* Messages */
  .messages-wrap {
    flex: 1;
    overflow-y: auto;
    padding: 32px 0;
    scroll-behavior: smooth;
  }

  .messages-wrap::-webkit-scrollbar { width: 4px; }
  .messages-wrap::-webkit-scrollbar-track { background: transparent; }
  .messages-wrap::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

  .messages-container {
    max-width: 780px;
    margin: 0 auto;
    padding: 0 28px;
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    gap: 16px;
    color: var(--muted);
    text-align: center;
  }

  .empty-icon {
    width: 56px; height: 56px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 26px;
    margin-bottom: 4px;
  }

  .empty-title { font-size: 20px; font-weight: 500; color: var(--text); }
  .empty-desc  { font-size: 13px; max-width: 360px; }

  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 8px;
  }

  .suggestion-chip {
    padding: 8px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 13px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Noto Serif SC', serif;
  }
  .suggestion-chip:hover {
    background: var(--surface2);
    border-color: var(--accent);
    color: var(--text);
  }

  /* Message row */
  .message-row {
    display: flex;
    gap: 14px;
    animation: fadeSlideIn 0.25s ease both;
  }

  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .message-row.user { flex-direction: row-reverse; }

  .avatar {
    width: 32px; height: 32px;
    border-radius: 8px;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    font-weight: 600;
    margin-top: 2px;
  }

  .avatar.user { background: linear-gradient(135deg, var(--accent), #a78bfa); color: #fff; }
  .avatar.ai   { background: var(--surface2); border: 1px solid var(--border); color: var(--accent2); font-size: 16px; }

  .bubble-wrap {
    flex: 1;
    max-width: calc(100% - 46px);
  }

  .sender-name {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 6px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.04em;
  }

  .message-row.user .sender-name { text-align: right; }

  .bubble {
    padding: 14px 18px;
    border-radius: 12px;
    font-size: 14.5px;
    line-height: 1.8;
    white-space: pre-wrap;
    word-break: break-word;
    position: relative;
  }

  .message-row.user .bubble {
    background: var(--user-bg);
    border: 1px solid var(--border);
    border-top-right-radius: 3px;
    color: var(--text);
    margin-left: auto;
    max-width: 480px;
  }

  .message-row.ai .bubble {
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 0;
    color: var(--text);
  }

  /* Markdown-like styling inside AI bubble */
  .bubble code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    background: var(--code-bg);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--accent2);
    border: 1px solid var(--border);
  }

  .bubble pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 18px;
    overflow-x: auto;
    margin: 12px 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    line-height: 1.6;
  }

  .bubble pre code {
    background: transparent;
    padding: 0;
    border: none;
    color: var(--text);
  }

  /* Cursor blink */
  .cursor {
    display: inline-block;
    width: 2px;
    height: 1em;
    background: var(--accent);
    margin-left: 1px;
    vertical-align: text-bottom;
    animation: blink 1s step-end infinite;
    border-radius: 1px;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0; }
  }

  /* Typing indicator */
  .typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 10px 0;
    height: 36px;
  }

  .typing-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    animation: typingPulse 1.2s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typingPulse {
    0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
    30%           { transform: scale(1.3); opacity: 1; }
  }

  /* ── Input Area ── */
  .input-area {
    padding: 20px 28px 24px;
    border-top: 1px solid var(--border);
    background: var(--bg);
    flex-shrink: 0;
  }

  .input-container {
    max-width: 780px;
    margin: 0 auto;
  }

  .input-box {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px 12px 12px 18px;
    transition: border-color 0.2s;
    position: relative;
  }
  .input-box:focus-within { border-color: var(--accent); }

  .input-box textarea {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    resize: none;
    color: var(--text);
    font-family: 'Noto Serif SC', serif;
    font-size: 14.5px;
    line-height: 1.7;
    max-height: 180px;
    min-height: 24px;
    overflow-y: auto;
    placeholder-color: var(--muted);
  }

  .input-box textarea::placeholder { color: var(--muted); }

  .input-box textarea::-webkit-scrollbar { width: 3px; }
  .input-box textarea::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

  .send-btn {
    width: 36px; height: 36px;
    border-radius: 9px;
    border: none;
    background: var(--accent);
    color: #fff;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .send-btn:hover  { background: #6d5ee0; transform: scale(1.05); }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled {
    background: var(--surface2);
    color: var(--muted);
    cursor: not-allowed;
    transform: none;
  }

  .stop-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
  }
  .stop-btn:hover { background: var(--surface); border-color: var(--danger); color: var(--danger); }

  .input-hint {
    font-size: 11px;
    color: var(--muted);
    margin-top: 8px;
    padding: 0 4px;
    display: flex;
    justify-content: space-between;
  }

  kbd {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1px 5px;
    color: var(--muted);
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 18px;
    font-size: 13px;
    color: var(--text);
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scrollbar for model select */
  .model-select option { background: var(--surface2); }

  /* Responsive */
  @media (max-width: 700px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { display: none; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-mark">✦</div>
      <span class="logo-text">AI 对话</span>
    </div>

    <button class="new-chat-btn" onclick="newChat()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      新建对话
    </button>

    <div class="chat-history-label">历史记录</div>

    <div class="chat-list" id="chatList">
      <!-- populated by JS -->
    </div>

    <div class="sidebar-footer">
      <select class="model-select" id="modelSelect" onchange="updateModel()">
        <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5</option>
        <option value="qwen2.5:7b">qwen2.5:7b</option>
        <option value="qwen2.5:14b">qwen2.5:14b</option>
        <option value="llama3.2:3b">llama3.2:3b</option>
        <option value="llama3.1:8b">llama3.1:8b</option>
        <option value="deepseek-r1:7b">deepseek-r1:7b</option>
        <option value="mistral:7b">mistral:7b</option>
        <option value="gemma3:4b">gemma3:4b</option>
        <option value="custom">自定义...</option>
      </select>
      <div class="status-dot">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">检查连接...</span>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="chat-header">
      <span class="chat-title" id="chatTitle">新对话</span>
      <div class="header-actions">
        <button class="icon-btn" title="清空对话" onclick="clearChat()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
        <button class="icon-btn" title="复制全部" onclick="copyAll()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        </button>
      </div>
    </div>

    <div class="messages-wrap" id="messagesWrap">
      <div class="messages-container" id="messagesContainer">

        <!-- Empty state -->
        <div class="empty-state" id="emptyState">
          <div class="empty-icon">✦</div>
          <div class="empty-title">有什么可以帮你的？</div>
          <div class="empty-desc">选择一个模型，开始对话。支持多轮上下文、流式输出。</div>
          <div class="suggestions">
            <div class="suggestion-chip" onclick="useSuggestion('解释一下量子纠缠是什么？')">解释量子纠缠</div>
            <div class="suggestion-chip" onclick="useSuggestion('用 Python 写一个快速排序算法')">快速排序 Python</div>
            <div class="suggestion-chip" onclick="useSuggestion('帮我写一封求职信，我应聘的是后端工程师')">写求职信</div>
            <div class="suggestion-chip" onclick="useSuggestion('推荐 5 本经典的科幻小说')">科幻书单推荐</div>
          </div>
        </div>

      </div>
    </div>

    <div class="input-area">
      <div class="input-container">
        <div class="input-box">
          <textarea
            id="inputArea"
            rows="1"
            placeholder="输入消息…（Shift+Enter 换行，Enter 发送）"
            onkeydown="handleKey(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="发送">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="input-hint">
          <span>模型可能出错，请自行核实重要信息</span>
          <span><kbd>Enter</kbd> 发送 &nbsp; <kbd>Shift</kbd>+<kbd>Enter</kbd> 换行</span>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
//  State
// ============================================================
const API_URL = '/api/chat/stream';

let messages      = [];    // {role, content}
let isStreaming   = false;
let currentReader = null;
let currentModel  = 'claude-sonnet-4-5-20250929';
let chatSessions  = [];
let currentSession = 0;

// ============================================================
//  Init
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  checkHealth();
  loadSessions();
  document.getElementById('inputArea').focus();
});

async function checkHealth() {
  const dot  = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  try {
    const r = await fetch('/api/health');
    if (r.ok) {
      const d = await r.json();
      dot.className  = 'dot connected';
      text.textContent = d.model || 'connected';
    } else {
      throw new Error();
    }
  } catch {
    dot.className  = 'dot error';
    text.textContent = '服务器未响应';
  }
}

// ============================================================
//  Session management (localStorage)
// ============================================================
function loadSessions() {
  try {
    const stored = JSON.parse(localStorage.getItem('chatSessions') || '[]');
    chatSessions = stored;
  } catch { chatSessions = []; }
  renderSessionList();
}

function saveSessions() {
  localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
}

function renderSessionList() {
  const list = document.getElementById('chatList');
  list.innerHTML = '';
  chatSessions.slice().reverse().forEach((s, idx) => {
    const realIdx = chatSessions.length - 1 - idx;
    const el = document.createElement('div');
    el.className = 'chat-item' + (realIdx === currentSession ? ' active' : '');
    el.textContent = s.title || '新对话';
    el.onclick = () => switchSession(realIdx);
    list.appendChild(el);
  });
}

function switchSession(idx) {
  currentSession = idx;
  messages = chatSessions[idx]?.messages || [];
  renderMessages();
  renderSessionList();
  document.getElementById('chatTitle').textContent = chatSessions[idx]?.title || '新对话';
}

function newChat() {
  chatSessions.push({ title: '新对话', messages: [] });
  currentSession = chatSessions.length - 1;
  messages = [];
  saveSessions();
  renderSessionList();
  renderMessages();
  document.getElementById('chatTitle').textContent = '新对话';
  document.getElementById('inputArea').focus();
}

// ============================================================
//  Render
// ============================================================
function renderMessages() {
  const container = document.getElementById('messagesContainer');
  const empty     = document.getElementById('emptyState');
  empty.style.display = messages.length ? 'none' : 'flex';
  
  // Remove all message rows
  container.querySelectorAll('.message-row').forEach(el => el.remove());

  messages.forEach(msg => appendMessageEl(msg.role, msg.content));
}

function appendMessageEl(role, content) {
  const container = document.getElementById('messagesContainer');
  document.getElementById('emptyState').style.display = 'none';

  const row  = document.createElement('div');
  row.className = `message-row ${role}`;

  const avatar = document.createElement('div');
  avatar.className = `avatar ${role}`;
  avatar.textContent = role === 'user' ? 'U' : '✦';

  const wrap   = document.createElement('div');
  wrap.className = 'bubble-wrap';

  const name   = document.createElement('div');
  name.className = 'sender-name';
  name.textContent = role === 'user' ? '你' : 'AI';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = renderContent(content);

  wrap.appendChild(name);
  wrap.appendChild(bubble);
  row.appendChild(avatar);
  row.appendChild(wrap);
  container.appendChild(row);

  scrollToBottom();
  return bubble;
}

// Simple markdown-like rendering
function renderContent(text) {
  if (!text) return '';
  // Code blocks
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => 
    `<pre><code>${escapeHtml(code.trim())}</code></pre>`);
  // Inline code
  text = text.replace(/`([^`]+)`/g, (_, c) => `<code>${escapeHtml(c)}</code>`);
  // Bold
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  // Italic
  text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
  // Escape remaining HTML (but not our tags)
  // Already handled by escapeHtml above for code blocks
  return text;
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function scrollToBottom(smooth = true) {
  const wrap = document.getElementById('messagesWrap');
  wrap.scrollTo({ top: wrap.scrollHeight, behavior: smooth ? 'smooth' : 'instant' });
}

// ============================================================
//  Send & Stream
// ============================================================
async function sendMessage() {
  if (isStreaming) return;

  const textarea = document.getElementById('inputArea');
  const text     = textarea.value.trim();
  if (!text) return;

  // Clear input
  textarea.value = '';
  autoResize(textarea);

  // Ensure we have a session
  if (chatSessions.length === 0) {
    chatSessions.push({ title: text.slice(0, 24), messages: [] });
    currentSession = 0;
  }

  // Add user message
  messages.push({ role: 'user', content: text });
  if (currentSession < chatSessions.length) {
    chatSessions[currentSession].messages = messages.slice();
    if (chatSessions[currentSession].title === '新对话') {
      chatSessions[currentSession].title = text.slice(0, 24) + (text.length > 24 ? '…' : '');
      document.getElementById('chatTitle').textContent = chatSessions[currentSession].title;
    }
    saveSessions();
    renderSessionList();
  }

  appendMessageEl('user', text);
  setStreaming(true);

  // Add AI placeholder
  const container = document.getElementById('messagesContainer');
  const aiRow = document.createElement('div');
  aiRow.className = 'message-row ai';

  const aiAvatar = document.createElement('div');
  aiAvatar.className = 'avatar ai';
  aiAvatar.textContent = '✦';

  const aiWrap = document.createElement('div');
  aiWrap.className = 'bubble-wrap';

  const aiName = document.createElement('div');
  aiName.className = 'sender-name';
  aiName.textContent = 'AI';

  const aiBubble = document.createElement('div');
  aiBubble.className = 'bubble';
  aiBubble.innerHTML = `<div class="typing-indicator">
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
  </div>`;

  aiWrap.appendChild(aiName);
  aiWrap.appendChild(aiBubble);
  aiRow.appendChild(aiAvatar);
  aiRow.appendChild(aiWrap);
  container.appendChild(aiRow);
  scrollToBottom();

  let aiText = '';

  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: currentModel,
        messages: messages
      })
    });

    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    const reader = resp.body.getReader();
    currentReader = reader;
    const decoder = new TextDecoder();

    aiBubble.innerHTML = '<span class="cursor"></span>';

    let buffer = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop(); // keep incomplete line

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed || !trimmed.startsWith('data: ')) continue;

        const data = trimmed.slice(6);
        if (data === '[DONE]') {
          // Stream complete
          break;
        }

        try {
          const parsed = JSON.parse(data);
          if (parsed.error) {
            aiText += `\n[错误: ${parsed.error}]`;
          } else if (parsed.token) {
            aiText += parsed.token;
          }
          // Update UI
          aiBubble.innerHTML = renderContent(aiText) + '<span class="cursor"></span>';
          scrollToBottom(false);
        } catch (e) {
          // Ignore parse errors
        }
      }
    }

    // Finalize
    aiBubble.innerHTML = renderContent(aiText || '（无响应）');

    // Save AI message
    messages.push({ role: 'assistant', content: aiText });
    if (currentSession < chatSessions.length) {
      chatSessions[currentSession].messages = messages.slice();
      saveSessions();
    }

  } catch (err) {
    if (err.name === 'AbortError') {
      aiBubble.innerHTML = renderContent(aiText) + '<span style="color:var(--muted);font-size:12px"> [已停止]</span>';
      messages.push({ role: 'assistant', content: aiText });
      if (currentSession < chatSessions.length) {
        chatSessions[currentSession].messages = messages.slice();
        saveSessions();
      }
    } else {
      aiBubble.innerHTML = `<span style="color:var(--danger)">连接失败: ${err.message}</span>`;
      showToast('连接失败，请检查服务器状态');
    }
  } finally {
    currentReader = null;
    setStreaming(false);
  }
}

function stopStream() {
  if (currentReader) {
    currentReader.cancel();
  }
}

function setStreaming(val) {
  isStreaming = val;
  const btn = document.getElementById('sendBtn');
  if (val) {
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>`;
    btn.className = 'send-btn stop-btn';
    btn.title = '停止';
    btn.onclick = stopStream;
  } else {
    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`;
    btn.className = 'send-btn';
    btn.title = '发送';
    btn.onclick = sendMessage;
  }
}

// ============================================================
//  UI helpers
// ============================================================
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

function useSuggestion(text) {
  const ta = document.getElementById('inputArea');
  ta.value = text;
  autoResize(ta);
  ta.focus();
}

function clearChat() {
  if (messages.length === 0) return;
  messages = [];
  if (currentSession < chatSessions.length) {
    chatSessions[currentSession].messages = [];
    saveSessions();
  }
  renderMessages();
  showToast('对话已清空');
}

function copyAll() {
  const text = messages.map(m => `${m.role === 'user' ? '你' : 'AI'}: ${m.content}`).join('\n\n');
  navigator.clipboard.writeText(text).then(() => showToast('已复制到剪贴板'));
}

function updateModel() {
  const sel = document.getElementById('modelSelect');
  if (sel.value === 'custom') {
    const m = prompt('输入模型名称：', currentModel);
    if (m) {
      currentModel = m;
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m; opt.selected = true;
      sel.insertBefore(opt, sel.lastElementChild);
      sel.value = m;
    } else {
      sel.value = currentModel;
    }
  } else {
    currentModel = sel.value;
  }
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}
</script>
</body>
</html>
